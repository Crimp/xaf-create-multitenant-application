jobs:
  - job: RunTests
    variables:
      runSettingsPath: '$(System.DefaultWorkingDirectory)\Tests\Tests.runsettings'
      testsFolderPath: '$(System.DefaultWorkingDirectory)\Tests'
      dxFeedVar: '$(DXFeed)'
      NUGET_PACKAGES: $(Pipeline.Workspace)/.nuget/packages
    strategy:
      matrix:
        Admin: {}
        Sales: {}
        Support: {}
        Management: {}
        Engineering: {}
        IT: {}
        Shipping: {}
        HumanResources: {}
    timeoutInMinutes: 60
    pool:
      vmImage: 'windows-latest'
    steps:
    - task: PowerShell@2
      displayName: Build
      continueOnError: false
      inputs:
        targetType: 'inline'
        script: |
          & sqllocaldb start mssqllocaldb
          dotnet nuget add source $(dxFeedVar) --name DX
          cd $env:BUILD_SOURCESDIRECTORY
          dotnet build --configuration TEST
        pwsh: true  
    - task: VSTest@2
      displayName: 'ImportData.Test'
      continueOnError: false
      enabled: true
      inputs:
        minimumExpectedTests: "1"
        failOnMinTestsNotRun: true
        searchFolder: $(testsFolderPath)
        testSelector: 'testAssemblies'
        testAssemblyVer2: |
          **\OutlookInspired.Win.Tests.dll
          !**\obj\**
        testFiltercriteria: TestCategory=ImportData
        diagnosticsEnabled: true
        codeCoverageEnabled: true
        runSettingsFile: $(runSettingsPath)
    - task: VSTest@2
      displayName: 'Windows.Test'
      continueOnError: false
      env:
        TEST_ROLE: $(Agent.JobName)
      inputs:
        minimumExpectedTests: "1"
        failOnMinTestsNotRun: true
        searchFolder: $(testsFolderPath)
        testSelector: 'testAssemblies'
        testAssemblyVer2: |
          **\OutlookInspired.Win.Tests.dll
          !**\obj\**
        testFiltercriteria: TestCategory=WindowsTest
        diagnosticsEnabled: true
        codeCoverageEnabled: true
        runSettingsFile: $(runSettingsPath)
    - task: VSTest@2
      displayName: 'Blazor.Test'
      continueOnError: false
      env:
        TEST_ROLE: $(Agent.JobName)
      inputs:
        minimumExpectedTests: "1"
        failOnMinTestsNotRun: true
        searchFolder: $(testsFolderPath)
        testSelector: 'testAssemblies'
        testAssemblyVer2: |
          **\OutlookInspired.Blazor.Tests.dll
          !**\obj\**
        testFiltercriteria: TestCategory=BlazorTest
        diagnosticsEnabled: true
        codeCoverageEnabled: true
        runSettingsFile: $(runSettingsPath)
    
